<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ランニングトラッカー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .bg-dark { background-color: #121212; }
        .bg-card { background-color: #1e1e1e; }
        .text-main { color: #e0e0e0; }
        .text-sub { color: #a0a0a0; }
        .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .modal.open .modal-content { transform: translateY(0); }
        .modal-content { transition: transform 0.3s ease-out; }
    </style>
</head>
<body class="bg-dark text-main antialiased">

    <div id="app-container" class="h-full w-full max-w-lg mx-auto bg-dark shadow-2xl flex flex-col">
        
        <!-- Header -->
        <header class="p-4 flex justify-between items-center flex-shrink-0 z-10">
            <h1 class="text-xl font-bold flex items-center">
                <i data-lucide="footprints" class="mr-2 text-cyan-400"></i>Run Tracker
            </h1>
            <button id="history-btn" class="p-2 rounded-full hover:bg-card transition-colors">
                <i data-lucide="history" class="w-6 h-6"></i>
            </button>
        </header>

        <!-- Map View -->
        <div id="map-container" class="flex-grow h-1/2 relative">
            <div id="map" class="h-full w-full"></div>
            <div id="permission-overlay" class="absolute inset-0 bg-black/70 flex-col items-center justify-center text-center p-4 hidden">
                <i data-lucide="map-pin-off" class="w-16 h-16 text-red-500 mb-4"></i>
                <h2 class="text-xl font-bold mb-2">位置情報が必要です</h2>
                <p class="text-sub">このアプリを使用するには、位置情報へのアクセスを許可してください。</p>
            </div>
        </div>

        <!-- Stats View -->
        <div id="stats-container" class="p-4 grid grid-cols-2 gap-4 flex-shrink-0">
            <div class="bg-card p-4 rounded-lg text-center">
                <p class="text-sm text-sub">距離 (km)</p>
                <p id="distance" class="text-3xl font-bold">0.00</p>
            </div>
            <div class="bg-card p-4 rounded-lg text-center">
                <p class="text-sm text-sub">ペース (分/km)</p>
                <p id="pace" class="text-3xl font-bold">--:--</p>
            </div>
            <div class="bg-card p-4 rounded-lg text-center">
                <p class="text-sm text-sub">時間</p>
                <p id="timer" class="text-3xl font-bold">00:00:00</p>
            </div>
            <div class="bg-card p-4 rounded-lg text-center">
                <p class="text-sm text-sub">推定歩数</p>
                <p id="steps" class="text-3xl font-bold">0</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="p-4 flex justify-around items-center flex-shrink-0">
            <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold rounded-full w-28 h-28 flex items-center justify-center text-2xl transition-all shadow-lg">
                <i data-lucide="play" class="w-10 h-10"></i>
            </button>
            <button id="pause-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-full w-28 h-28 items-center justify-center text-2xl transition-all shadow-lg hidden">
                <i data-lucide="pause" class="w-10 h-10"></i>
            </button>
            <button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold rounded-full w-20 h-20 items-center justify-center text-xl transition-all shadow-md hidden">
                <i data-lucide="square" class="w-8 h-8"></i>
            </button>
        </div>

    </div>
    
    <!-- History Modal -->
    <div id="history-modal" class="modal fixed inset-0 z-30 flex flex-col justify-end bg-black bg-opacity-70 hidden">
        <div class="modal-content w-full max-w-lg mx-auto bg-card rounded-t-2xl p-5 transform translate-y-full flex flex-col max-h-[80vh]">
            <div class="text-center mb-4 flex-shrink-0"><div class="inline-block w-10 h-1.5 bg-gray-600 rounded-full"></div></div>
            <h3 class="text-xl font-bold text-center mb-5 flex-shrink-0">ランニング履歴</h3>
            <div id="history-list" class="flex-grow overflow-y-auto space-y-3">
                <!-- History items will be injected here -->
            </div>
            <button id="close-history-btn" class="mt-4 w-full bg-cyan-500 text-white font-bold py-3 rounded-lg">閉じる</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const getEl = (id) => document.getElementById(id);

        // --- DOM Elements ---
        const distanceEl = getEl('distance');
        const paceEl = getEl('pace');
        const timerEl = getEl('timer');
        const stepsEl = getEl('steps');
        const startBtn = getEl('start-btn');
        const pauseBtn = getEl('pause-btn');
        const stopBtn = getEl('stop-btn');
        const historyBtn = getEl('history-btn');
        const historyModal = getEl('history-modal');
        const closeHistoryBtn = getEl('close-history-btn');
        const historyList = getEl('history-list');

        // --- State ---
        let map, polyline, userMarker;
        let isRunning = false;
        let isPaused = false;
        let watchId = null;
        let startTime = 0;
        let pausedTime = 0;
        let totalPausedTime = 0;
        let timerInterval = null;
        let totalDistance = 0; // in meters
        let routeCoordinates = [];
        let runHistory = [];
        const AVERAGE_STRIDE_METERS = 0.762;

        // --- Initialization ---
        const init = () => {
            lucide.createIcons();
            initMap();
            loadHistory();
            attachEventListeners();
        };

        const initMap = () => {
            map = L.map('map').setView([35.681236, 139.767125], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            // Try to get current location to center map
            navigator.geolocation.getCurrentPosition(
                (position) => map.setView([position.coords.latitude, position.coords.longitude], 16),
                handleLocationError
            );
        };
        
        const loadHistory = () => {
            runHistory = JSON.parse(localStorage.getItem('runHistory')) || [];
        };

        const saveHistory = () => {
            localStorage.setItem('runHistory', JSON.stringify(runHistory));
        };

        // --- UI Functions ---
        const updateTimer = () => {
            if (!isRunning || isPaused) return;
            const now = Date.now();
            const elapsed = now - startTime - totalPausedTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };
        
        const updateStats = () => {
            const distanceKm = totalDistance / 1000;
            distanceEl.textContent = distanceKm.toFixed(2);
            
            stepsEl.textContent = Math.round(totalDistance / AVERAGE_STRIDE_METERS);

            const elapsedSeconds = (Date.now() - startTime - totalPausedTime) / 1000;
            if (distanceKm > 0 && elapsedSeconds > 0) {
                const paceSecondsPerKm = elapsedSeconds / distanceKm;
                const paceMinutes = Math.floor(paceSecondsPerKm / 60);
                const paceSeconds = Math.floor(paceSecondsPerKm % 60);
                paceEl.textContent = `${String(paceMinutes).padStart(2, '0')}:${String(paceSeconds).padStart(2, '0')}`;
            } else {
                paceEl.textContent = '--:--';
            }
        };

        const renderHistory = () => {
            historyList.innerHTML = '';
            if (runHistory.length === 0) {
                historyList.innerHTML = `<div class="text-center text-sub p-8"><i data-lucide="archive-x" class="w-16 h-16 mx-auto"></i><p class="mt-4">まだ履歴はありません。</p></div>`;
                lucide.createIcons(); return;
            }
            [...runHistory].reverse().forEach(run => {
                const item = document.createElement('div');
                item.className = 'bg-dark p-4 rounded-lg';
                item.innerHTML = `
                    <p class="font-bold">${new Date(run.date).toLocaleString('ja-JP')}</p>
                    <div class="grid grid-cols-3 gap-2 mt-2 text-center">
                        <div><p class="text-xs text-sub">距離</p><p>${run.distance.toFixed(2)} km</p></div>
                        <div><p class="text-xs text-sub">時間</p><p>${run.time}</p></div>
                        <div><p class="text-xs text-sub">ペース</p><p>${run.pace}</p></div>
                    </div>
                `;
                historyList.appendChild(item);
            });
        };
        
        // --- Run Logic ---
        const startRun = () => {
            if (isRunning) return;
            resetState();
            isRunning = true;
            isPaused = false;
            startTime = Date.now();
            totalPausedTime = 0;
            timerInterval = setInterval(updateTimer, 1000);
            
            startBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            pauseBtn.style.display = 'flex';
            stopBtn.classList.remove('hidden');
            stopBtn.style.display = 'flex';
            
            polyline = L.polyline([], { color: '#06b6d4', weight: 5 }).addTo(map);

            watchId = navigator.geolocation.watchPosition(
                updatePosition,
                handleLocationError,
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        };
        
        const pauseRun = () => {
            if (!isRunning) return;
            if (isPaused) { // Resume
                isPaused = false;
                totalPausedTime += Date.now() - pausedTime;
                pauseBtn.innerHTML = `<i data-lucide="pause" class="w-10 h-10"></i>`;
                lucide.createIcons();
            } else { // Pause
                isPaused = true;
                pausedTime = Date.now();
                pauseBtn.innerHTML = `<i data-lucide="play" class="w-10 h-10"></i>`;
                lucide.createIcons();
            }
        };

        const stopRun = () => {
            if (!isRunning) return;
            
            // Save final run data
            const finalDistanceKm = totalDistance / 1000;
            const finalTime = timerEl.textContent;
            const finalPace = paceEl.textContent;
            if (finalDistanceKm > 0.01) { // Only save meaningful runs
                runHistory.push({
                    date: new Date().toISOString(),
                    distance: finalDistanceKm,
                    time: finalTime,
                    pace: finalPace
                });
                saveHistory();
            }
            
            resetState(true);
        };

        const resetState = (isStopping = false) => {
            isRunning = false; isPaused = false;
            clearInterval(timerInterval);
            if (watchId) navigator.geolocation.clearWatch(watchId);
            watchId = null;
            
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
            stopBtn.classList.add('hidden');
            
            if (isStopping) {
                totalDistance = 0;
                routeCoordinates = [];
                distanceEl.textContent = '0.00';
                paceEl.textContent = '--:--';
                timerEl.textContent = '00:00:00';
                stepsEl.textContent = '0';
                if(polyline) map.removeLayer(polyline);
                if(userMarker) map.removeLayer(userMarker);
                polyline = null; userMarker = null;
            }
        };

        // --- Geolocation Handlers ---
        const updatePosition = (position) => {
            if(isPaused) return;
            const { latitude, longitude } = position.coords;
            const newCoord = [latitude, longitude];

            map.setView(newCoord, 17);
            
            if (userMarker) {
                userMarker.setLatLng(newCoord);
            } else {
                userMarker = L.circle(newCoord, {
                    color: '#67e8f9',
                    fillColor: '#06b6d4',
                    fillOpacity: 0.8,
                    radius: 8
                }).addTo(map);
            }
            
            if (routeCoordinates.length > 0) {
                const lastCoord = routeCoordinates[routeCoordinates.length - 1];
                totalDistance += L.latLng(lastCoord).distanceTo(L.latLng(newCoord));
            }

            routeCoordinates.push(newCoord);
            polyline.setLatLngs(routeCoordinates);
            updateStats();
        };

        const handleLocationError = (error) => {
            console.error(error);
            getEl('permission-overlay').style.display = 'flex';
        };

        // --- Event Listeners ---
        const attachEventListeners = () => {
            startBtn.addEventListener('click', startRun);
            pauseBtn.addEventListener('click', pauseRun);
            stopBtn.addEventListener('click', () => { if(confirm('ランニングを終了しますか？')) stopRun(); });

            historyBtn.addEventListener('click', () => {
                renderHistory();
                historyModal.classList.remove('hidden');
                requestAnimationFrame(() => historyModal.classList.add('open'));
            });
            closeHistoryBtn.addEventListener('click', () => {
                historyModal.classList.remove('open');
                setTimeout(() => historyModal.classList.add('hidden'), 300);
            });
        };
        
        init();
    });
    </script>
</body>
</html>

